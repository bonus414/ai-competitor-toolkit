const CompetitorResearcher = require('./competitor-research');
const fs = require('fs');
const path = require('path');

async function batchResearch() {
  console.log('ðŸš€ Starting batch competitor research...\n');

  // Load competitors from JSON
  const competitorsPath = path.join(__dirname, '..', 'competitors.json');

  if (!fs.existsSync(competitorsPath)) {
    console.error('âŒ competitors.json not found. Please create it from competitors.template.json');
    process.exit(1);
  }

  const competitorsData = JSON.parse(
    fs.readFileSync(competitorsPath, 'utf8')
  );

  // Flatten all competitor tiers into a single array
  const allCompetitors = [
    ...(competitorsData.competitors.tier_1_must_research || []),
    ...(competitorsData.competitors.tier_2_should_research || []),
    ...(competitorsData.competitors.tier_3_nice_to_have || [])
  ];

  const researcher = new CompetitorResearcher();
  const results = [];

  try {
    await researcher.initialize();

    for (const competitor of allCompetitors) {
      if (competitor.status === 'completed') {
        console.log(`â­ï¸  Skipping ${competitor.name} (already researched)`);
        continue;
      }
      
      console.log(`\n${'='.repeat(50)}`);
      console.log(`ðŸ” Researching: ${competitor.name}`);
      console.log(`ðŸŒ Website: ${competitor.url}`);
      console.log(`${'='.repeat(50)}`);

      const researchData = await researcher.researchCompetitor(competitor.name, competitor.url);
      const reportPath = await researcher.generateReport(researchData);
      
      results.push({
        name: competitor.name,
        success: !researchData.error,
        reportPath: reportPath,
        screenshots: researchData.screenshots.length,
        error: researchData.error
      });
      
      // Update competitor status
      competitor.status = 'completed';
      competitor.researched_date = new Date().toISOString().split('T')[0];
      competitor.screenshots_count = researchData.screenshots.length;

      console.log(`âœ… Completed: ${competitor.name}`);
    }

    // Save updated competitors data
    fs.writeFileSync(
      competitorsPath,
      JSON.stringify(competitorsData, null, 2)
    );
    
    // Generate summary report
    generateSummaryReport(results);
    
  } catch (error) {
    console.error('âŒ Fatal error during batch research:', error);
  } finally {
    await researcher.close();
  }
}

function generateSummaryReport(results) {
  const summaryPath = path.join(__dirname, '..', 'reports', `batch-research-summary-${new Date().toISOString().split('T')[0]}.md`);
  
  const successful = results.filter(r => r.success);
  const failed = results.filter(r => !r.success);
  
  const summary = `# Batch Competitor Research Summary
Date: ${new Date().toISOString().split('T')[0]}
Generated by: Playwright MCP

## Overview
- **Total Competitors**: ${results.length}
- **Successful**: ${successful.length}
- **Failed**: ${failed.length}

## Results

### âœ… Successful Research
${successful.map(r => `- **${r.name}**: ${r.screenshots} screenshots captured`).join('\n')}

### âŒ Failed Research
${failed.map(r => `- **${r.name}**: ${r.error}`).join('\n')}

## Individual Reports
${results.map(r => `- [${r.name}](./${path.basename(r.reportPath)})`).join('\n')}

## Next Steps
1. Review individual reports for detailed analysis
2. Examine captured screenshots for visual insights
3. Update research template based on findings
4. Plan follow-up research for failed competitors
`;

  fs.writeFileSync(summaryPath, summary);
  console.log(`\nðŸ“Š Summary report saved: ${summaryPath}`);
}

// Run if called directly
if (require.main === module) {
  batchResearch().catch(console.error);
}

module.exports = { batchResearch };
