const CompetitorResearcher = require('./competitor-research');
const fs = require('fs');
const path = require('path');

async function batchResearch() {
  console.log('ğŸš€ Starting batch competitor research...\n');

  // Load competitors from JSON
  const competitorsPath = path.join(__dirname, '..', 'competitors.json');

  if (!fs.existsSync(competitorsPath)) {
    console.error('âŒ competitors.json not found. Please create it from competitors.template.json');
    process.exit(1);
  }

  const competitorsData = JSON.parse(
    fs.readFileSync(competitorsPath, 'utf8')
  );

  // Flatten all competitor tiers into a single array
  const allCompetitors = [
    ...(competitorsData.competitors.tier_1_must_research || []),
    ...(competitorsData.competitors.tier_2_should_research || []),
    ...(competitorsData.competitors.tier_3_nice_to_have || [])
  ];

  const researcher = new CompetitorResearcher();
  const results = [];

  try {
    await researcher.initialize();

    for (const competitor of allCompetitors) {
      if (competitor.status === 'completed') {
        console.log(`â­ï¸  Skipping ${competitor.name} (already researched)`);
        continue;
      }

      console.log(`\n${'='.repeat(50)}`);
      console.log(`ğŸ” Researching: ${competitor.name}`);
      console.log(`ğŸŒ Website: ${competitor.url}`);
      console.log(`${'='.repeat(50)}`);

      // Create fresh browser context to avoid state pollution between competitors
      if (results.length > 0) {
        console.log('ğŸ”„ Creating fresh browser context...');
        await researcher.createFreshContext();
      }

      const researchData = await researcher.researchCompetitor(competitor.name, competitor.url);
      const reportPath = await researcher.generateReport(researchData);

      results.push({
        name: competitor.name,
        url: competitor.url,
        success: !researchData.error,
        reportPath: reportPath,
        screenshots: researchData.screenshots.length,
        error: researchData.error,
        error_type: researchData.error_type,
        error_category: researchData.error_category
      });
      
      // Update competitor status
      competitor.status = 'completed';
      competitor.researched_date = new Date().toISOString().split('T')[0];
      competitor.screenshots_count = researchData.screenshots.length;

      console.log(`âœ… Completed: ${competitor.name}`);
    }

    // Save updated competitors data
    fs.writeFileSync(
      competitorsPath,
      JSON.stringify(competitorsData, null, 2)
    );
    
    // Generate summary report
    generateSummaryReport(results);
    
  } catch (error) {
    console.error('âŒ Fatal error during batch research:', error);
  } finally {
    await researcher.close();
  }
}

function generateSummaryReport(results) {
  const summaryPath = path.join(__dirname, '..', 'reports', `batch-research-summary-${new Date().toISOString().split('T')[0]}.md`);

  const successful = results.filter(r => r.success);
  const failed = results.filter(r => !r.success);

  // Categorize failures
  const siteDown = failed.filter(r => r.error_type === 'site_down');
  const timeout = failed.filter(r => r.error_type === 'timeout');
  const navIssues = failed.filter(r => r.error_type === 'navigation_issue');
  const unknown = failed.filter(r => r.error_type === 'unknown' || !r.error_type);

  const summary = `# Batch Competitor Research Summary
Date: ${new Date().toISOString().split('T')[0]}
Generated by: Playwright MCP

## Overview
- **Total Competitors**: ${results.length}
- **âœ… Successful**: ${successful.length}
- **âŒ Failed**: ${failed.length}

## Results

### âœ… Successful Research (${successful.length})
${successful.length > 0 ? successful.map(r => `- **${r.name}**: ${r.screenshots} screenshots captured`).join('\n') : '_No successful research_'}

### âŒ Failed Research (${failed.length})

${siteDown.length > 0 ? `#### ğŸ”´ Site Down / DNS Issues (${siteDown.length})
${siteDown.map(r => `- **${r.name}**: Site appears offline or defunct
  - URL: ${r.url || 'N/A'}
  - Action: Verify domain manually or remove from competitor list`).join('\n')}
` : ''}
${timeout.length > 0 ? `#### â±ï¸ Timeout / Slow Loading (${timeout.length})
${timeout.map(r => `- **${r.name}**: Site too slow or has anti-bot protection
  - URL: ${r.url || 'N/A'}
  - Action: Research manually with a regular browser`).join('\n')}
` : ''}
${navIssues.length > 0 ? `#### ğŸ”„ Navigation Issues (${navIssues.length})
${navIssues.map(r => `- **${r.name}**: Complex redirects or JavaScript requirements
  - URL: ${r.url || 'N/A'}
  - Action: Check URL manually, may need different approach`).join('\n')}
` : ''}
${unknown.length > 0 ? `#### â“ Unknown Errors (${unknown.length})
${unknown.map(r => `- **${r.name}**: ${r.error || 'Unexpected error'}
  - URL: ${r.url || 'N/A'}
  - Action: Review error details in individual report`).join('\n')}
` : ''}

## Individual Reports
${results.map(r => `- [${r.name}](./${path.basename(r.reportPath)}) ${!r.success ? 'âŒ' : 'âœ…'}`).join('\n')}

## Next Steps
1. âœ… **Successful competitors**: Review reports and screenshots for insights
2. ğŸ”´ **Sites down**: Consider removing defunct competitors from your list
3. â±ï¸ **Timeouts**: Research these manually - they may have anti-bot measures
4. ğŸ”„ **Navigation issues**: Check URLs and try alternative approaches
5. Update \`competitors.json\` based on findings
`;

  fs.writeFileSync(summaryPath, summary);
  console.log(`\nğŸ“Š Summary report saved: ${summaryPath}`);
}

// Run if called directly
if (require.main === module) {
  batchResearch().catch(console.error);
}

module.exports = { batchResearch };
